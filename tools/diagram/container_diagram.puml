@startuml container_diagram
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

' Container Diagram (C4 - Level 2) for the microservice project
'  - Reflects containers discovered in the workspace under `apps/`
'  - Datastores used: PostgreSQL (used by `shrine-service`, `wishing-service`) and MongoDB (used by `technique-service`, `shrine-discovery-service`)
'  - How to render: use PlantUML or an online PlantUML server that allows external includes
'  - Assumptions: the API Gateway routes HTTP requests from the frontend to each service and also/or calls services via gRPC where applicable.

title Container Diagram (Level 2) â€” Microservice

' People
Person(user, "User", "Primary end-user")
Person(admin, "Admin", "Administrator / Operator")

' System boundary representing the overall system
System_Boundary(core, "Sai-mu Microservices") {
  Container(frontend, "Frontend (Web)", "React / Vite", "Single-page application served to users")

  Container(api_gateway, "API Gateway", "NestJS", "Routes HTTP from frontend, aggregates and proxies to microservices (HTTP/gRPC).")

  Container(shrine_discovery, "Shrine Discovery Service", "NestJS (gRPC) + Mongoose", "Provides shrine discovery/search; stores discoveries in MongoDB.")

  Container(shrine_service, "Shrine Service", "NestJS + TypeORM", "Manages shrine data and metadata; uses PostgreSQL")

  Container(technique_service, "Technique Service", "NestJS + Mongoose", "Manages techniques and related media; uses MongoDB")

  Container(wishing_service, "Wishing Service", "NestJS + TypeORM", "Handles wishes for shrines; uses PostgreSQL")
  
  Container(location_service, "Location Service", "NestJS", "Provides geolocation and place lookups; may call external geocoding APIs.")

  Container(rating_service, "Rating Service", "NestJS + TypeORM", "Handles ratings for shrines/techniques; stores aggregates in PostgreSQL.")

  Container(user_service, "User Service", "NestJS + TypeORM", "Manages user accounts, profiles and auth-related data; stores users in PostgreSQL.")

  ContainerDb(pg_shrine_db, "Shrine PostgreSQL", "PostgreSQL", "Holds shrine relational data (used by Shrine Service)")
  ContainerDb(pg_wishing_db, "Wishing PostgreSQL", "PostgreSQL", "Holds wish records (used by Wishing Service)")

  ContainerDb(pg_user_db, "User PostgreSQL", "PostgreSQL", "Stores user account/profile data (used by User Service)")
  ContainerDb(pg_rating_db, "Rating PostgreSQL", "PostgreSQL", "Stores ratings and aggregates (used by Rating Service)")

  ContainerDb(mongo_technique, "Technique MongoDB", "MongoDB", "Stores technique documents (used by Technique Service)")
  ContainerDb(mongo_discovery, "Discovery MongoDB", "MongoDB", "Stores shrine discovery documents (used by Shrine Discovery Service)")

  Container(mq, "Message Broker (RabbitMQ)", "RabbitMQ", "Event bus used for async events between services (wishes, user events, rating events).")
}

' External systems (optional)
System_Ext(oauth, "OAuth Provider", "External identity provider (optional)")
System_Ext(google_maps, "Google Maps Platform", "External mapping & geocoding API")

' Relationships
Rel(user, frontend, "Uses", "Web Browser")
Rel(frontend, api_gateway, "Sends API requests to", "HTTPS / JSON")

Rel(admin, frontend, "Uses (Admin UI)", "Web Browser")
Rel(admin, api_gateway, "Calls admin endpoints", "HTTPS / JSON")

Rel(api_gateway, shrine_service, "Forwards requests to", "HTTP/gRPC")
Rel(api_gateway, technique_service, "Forwards requests to", "HTTP/gRPC")
Rel(api_gateway, wishing_service, "Forwards requests to", "HTTP/gRPC")
Rel(api_gateway, shrine_discovery, "Forwards search/discovery requests to", "HTTP/gRPC")
Rel(api_gateway, location_service, "Forwards location requests to", "HTTP")
Rel(api_gateway, rating_service, "Forwards rating requests to", "HTTP")
Rel(api_gateway, user_service, "Forwards user/account requests to", "HTTP / OAuth-protected")

Rel(shrine_service, pg_shrine_db, "Reads from and writes to", "PostgreSQL (TypeORM)")
Rel(wishing_service, pg_wishing_db, "Reads from and writes to", "PostgreSQL (TypeORM)")

Rel(user_service, pg_user_db, "Reads from and writes to", "PostgreSQL (TypeORM)")
Rel(rating_service, pg_rating_db, "Reads from and writes to", "PostgreSQL (TypeORM)")

Rel(technique_service, mongo_technique, "Reads from and writes to", "MongoDB (Mongoose)")
Rel(shrine_discovery, mongo_discovery, "Reads from and writes to", "MongoDB (Mongoose)")

Rel_L(mq, shrine_service, "Receives/publishes events to/from", "AMQP")
Rel_L(mq, wishing_service, "Receives/publishes events to/from", "AMQP")
Rel_L(mq, user_service, "Receives/publishes user-events to/from", "AMQP")
Rel_L(mq, rating_service, "Receives/publishes rating-events to/from", "AMQP")

Rel_L(api_gateway, oauth, "Uses for auth", "OAuth 2.0 / OpenID Connect")
Rel(location_service, google_maps, "Calls for geocoding & map data", "HTTPS / REST")

' Styling hints (optional)
SHOW_LEGEND()

@enduml
