@startuml component_diagram
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

' Component Diagram (C4 - Level 3) for the microservice project
'  - Shows components inside selected containers (API Gateway, Shrine Service, Technique Service, Wishing Service, Shrine Discovery, User Service, Rating Service, Location Service)
'  - Includes key infrastructure: PostgreSQL databases and RabbitMQ message broker
'  - How to render: use PlantUML (local jar or Docker image) or the VS Code PlantUML extension

title Component Diagram (Level 3) — Sai-mu Microservices

Person(user, "User", "End user interacting via the web frontend")
Person(admin, "Admin", "Administrator / operator")

System_Boundary(core, "Sai-mu Microservices — Components") {
  Container(frontend, "Frontend (Web)", "React / Vite", "Single-page application")

  Container(api_gateway, "API Gateway", "NestJS", "Routes HTTP from frontend, aggregates and proxies to microservices (HTTP/gRPC).") {
    Component(api_http, "HTTP Controller", "Handles incoming HTTP endpoints and routing")
    Component(api_auth, "Auth Middleware", "Validates tokens and enforces auth/roles")
    Component(api_aggregator, "Response Aggregator", "Combines data from multiple services for composite endpoints")
    Component(api_proxy, "Service Proxy / gRPC Client", "Forwards and transforms requests to downstream services (HTTP/gRPC)")
  }

  Container(shrine_service, "Shrine Service", "NestJS + TypeORM", "Manages shrine data and metadata") {
    Component(shrine_controller, "Shrine Controller", "HTTP/gRPC endpoints for shrine operations")
    Component(shrine_core, "Shrine Domain Service", "Business logic for shrine lifecycle")
    Component(shrine_repo, "Shrine Repository (TypeORM)", "Persists shrine entities to PostgreSQL")
    Component(shrine_event_pub, "Event Publisher", "Publishes domain events to RabbitMQ")
  }

  Container(technique_service, "Technique Service", "NestJS + Mongoose", "Manages techniques and media") {
    Component(tech_controller, "Technique Controller", "HTTP endpoints for technique CRUD")
    Component(tech_core, "Technique Domain Service", "Business logic and validation")
    Component(tech_repo, "Technique Repository (Mongoose)", "CRUD for technique documents in MongoDB")
    ' Component(tech_media, "Media Handler", "Integration with object store / CDN for media files")
  }

  Container(wishing_service, "Wishing Service", "NestJS + TypeORM", "Handles user wishes for shrines") {
    Component(wish_controller, "Wishing Controller", "Exposes wish-related endpoints")
    Component(wish_core, "Wish Handler", "Validates and processes wish creation")
    Component(wish_repo, "Wish Repository (TypeORM)", "Persists wishes in PostgreSQL")
    Component(wish_event_pub, "Wish Event Publisher", "Sends wish events to RabbitMQ")
  }

  Container(shrine_discovery, "Shrine Discovery Service", "NestJS + Mongoose", "Search/indexer for shrines") {
    Component(sd_api, "Discovery Controller", "Search and discovery endpoints (gRPC/HTTP)")
    Component(sd_indexer, "Indexer / Search Service", "Maintains search index and relevance logic")
    Component(sd_repo, "Discovery Repository (Mongoose)", "Search documents in MongoDB")
  }

  Container(user_service, "User Service", "NestJS + TypeORM", "Manages users and accounts") {
    Component(user_controller, "User Controller", "Profile and account endpoints")
    Component(user_core, "User Domain Service", "Registration, profile updates, password handling")
    Component(user_repo, "User Repository (TypeORM)", "Persists user data to PostgreSQL")
    Component(user_auth, "Token Manager / Auth Utilities", "Issues/validates JWTs, integrates with OAuth provider")
    Component(user_event_pub, "User Event Publisher", "Publishes user-related events to RabbitMQ")
  }

  Container(rating_service, "Rating Service", "NestJS + TypeORM", "Manages ratings and aggregates") {
    Component(rating_controller, "Rating Controller", "Endpoints for submitting and retrieving ratings")
    Component(rating_core, "Rating Service", "Calculates aggregates and business rules")
    Component(rating_repo, "Rating Repository (TypeORM)", "Persists rating data to PostgreSQL")
    Component(rating_event_sub, "Rating Event Subscriber", "Consumes relevant events from RabbitMQ to update aggregates")
  }

  Container(location_service, "Location Service", "NestJS", "Geolocation helper and external geocoding integration") {
    Component(loc_api, "Location Controller", "Endpoints for geocoding/address lookups")
    Component(loc_core, "Geocoding Service", "Calls external geocoding APIs and caches results")
  }

  ' Datastores and infra as containers so relationships are visible at component level
  ContainerDb(pg_shrine_db, "Shrine PostgreSQL", "PostgreSQL", "Relational store for shrine data")
  ContainerDb(pg_wishing_db, "Wishing PostgreSQL", "PostgreSQL", "Relational store for wishes")
  ContainerDb(pg_user_db, "User PostgreSQL", "PostgreSQL", "Relational store for user accounts")
  ContainerDb(pg_rating_db, "Rating PostgreSQL", "PostgreSQL", "Relational store for ratings")

  ContainerDb(mongo_technique, "Technique MongoDB", "MongoDB", "Stores technique documents")
  ContainerDb(mongo_discovery, "Discovery MongoDB", "MongoDB", "Stores discovery/search documents")

  Container(mq, "Message Broker (RabbitMQ)", "RabbitMQ", "Async event bus for domain events")
}

' External auth provider
System_Ext(oauth, "OAuth Provider", "External identity provider")

' External geocoding provider (third-party)
System_Ext(geocoding_ext, "Geocoding Provider", "External Google Maps API")

' Relationships (component-level)
Rel(user, frontend, "Uses", "Web Browser")
Rel(frontend, api_gateway, "Calls", "HTTPS / JSON")
Rel(admin, frontend, "Uses (Admin UI)", "Web Browser")
Rel(admin, api_gateway, "Calls admin endpoints", "HTTPS / JSON")

' API Gateway internals communicating with downstream services
Rel(api_http, api_auth, "uses", "token validation")
Rel(api_http, api_aggregator, "delegates to", "composes responses")
Rel(api_aggregator, api_proxy, "calls", "HTTP/gRPC")

Rel(api_proxy, shrine_controller, "calls", "HTTP/gRPC")
Rel(api_proxy, tech_controller, "calls", "HTTP/gRPC")
Rel(api_proxy, wish_controller, "calls", "HTTP/gRPC")
Rel(api_proxy, sd_api, "calls", "HTTP/gRPC")
Rel(api_proxy, user_controller, "calls", "HTTP / OAuth-protected")
Rel(api_proxy, rating_controller, "calls", "HTTP")
Rel(api_proxy, loc_api, "calls", "HTTP")

' Shrine Service internals and infra
Rel(shrine_controller, shrine_core, "uses", "domain logic")
Rel(shrine_core, shrine_repo, "persists to", "PostgreSQL (TypeORM)")
Rel(shrine_core, shrine_event_pub, "publishes", "AMQP")
Rel(shrine_repo, pg_shrine_db, "reads/writes to", "PostgreSQL")
Rel(shrine_event_pub, mq, "publishes", "AMQP")

' Technique Service internals
Rel(tech_controller, tech_core, "uses", "business logic")
Rel(tech_core, tech_repo, "persists to", "MongoDB (Mongoose)")
Rel(tech_repo, mongo_technique, "reads/writes to", "MongoDB")
' Rel(tech_core, tech_media, "stores media in", "object store / CDN")

' Wishing Service internals
Rel(wish_controller, wish_core, "uses", "business logic")
Rel(wish_core, wish_repo, "persists to", "PostgreSQL")
Rel(wish_core, wish_event_pub, "publishes", "AMQP")
Rel(wish_repo, pg_wishing_db, "reads/writes to", "PostgreSQL")
Rel(wish_event_pub, mq, "publishes", "AMQP")

' Shrine Discovery internals
Rel(sd_api, sd_indexer, "uses", "index/search logic")
Rel(sd_indexer, sd_repo, "reads/writes to", "MongoDB")
Rel(sd_repo, mongo_discovery, "reads/writes to", "MongoDB")

' User Service internals
Rel(user_controller, user_core, "uses", "business logic")
Rel(user_core, user_repo, "persists to", "PostgreSQL")
Rel(user_repo, pg_user_db, "reads/writes to", "PostgreSQL")
Rel(user_core, user_auth, "uses", "JWT/OAuth integration")
Rel(user_event_pub, mq, "publishes", "AMQP")

' Rating Service internals
Rel(rating_controller, rating_core, "uses", "business rules")
Rel(rating_core, rating_repo, "persists to", "PostgreSQL")
Rel(rating_repo, pg_rating_db, "reads/writes to", "PostgreSQL")
Rel(rating_event_sub, mq, "subscribes to", "AMQP")

' Location Service internals
Rel(loc_api, loc_core, "uses", "calls external geocoding APIs")
Rel(loc_core, loc_cache, "reads/writes to", "in-memory/Redis cache")
Rel_L(loc_core, geocoding_ext, "calls", "HTTPS / API key")

' Cross-service event relationships (component-level)
Rel_L(mq, rating_event_sub, "rating-update events ->", "AMQP")
Rel_L(mq, shrine_event_pub, "shrinedomain events ->", "AMQP")
Rel_L(mq, wish_event_pub, "wish events ->", "AMQP")
Rel_L(mq, user_event_pub, "user events ->", "AMQP")

' API Gateway uses external OAuth provider
Rel_L(api_auth, oauth, "validates tokens with", "OAuth 2.0 / OpenID Connect")

SHOW_LEGEND()
@enduml
