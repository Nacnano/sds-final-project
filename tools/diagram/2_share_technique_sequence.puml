@startuml share_technique_sequence
title Use case 2: Share Wishing Technique & Outcome - Sequence Diagram
' Render with VS Code PlantUML extension or PlantUML server/CLI
actor User as "User\n(ผู้ใช้)"
actor User as "User"

participant "Frontend\nWeb/Mobile" as Frontend
participant "API Gateway" as APIGateway
participant "User Service\n(Auth)" as AuthService
participant "Technique Service" as TechniqueService
database "Technique DB" as TechniqueDB
participant "Rating Service" as RatingService
database "Rating DB" as RatingDB
participant "Shrine Discovery Service" as DiscoveryService

note over Frontend,APIGateway
  Data shape: technique = { shrineId, items[], steps[], photos[], outcome:{success|failure}, rating:1..5, notes }
end note

== Submit technique ==
User -> Frontend : Open "Share Technique" (select shrine, add items/steps/photos/outcome)
Frontend -> APIGateway : POST /techniques  (technique payload, auth token)

alt Authenticated
  APIGateway -> AuthService : Verify token
  AuthService --> APIGateway : 200 OK (userId)

  APIGateway -> TechniqueService : CreateTechnique(userId, technique)
  activate TechniqueService

  TechniqueService -> TechniqueDB : INSERT technique
  activate TechniqueDB
  TechniqueDB --> TechniqueService : 201 Created (techniqueId)
  deactivate TechniqueDB

  note right of TechniqueService
    Persist technique and link to shrine + user
  end note

  TechniqueService ->> RatingService : PublishTechniqueOutcomeEvent(shrineId, outcome, rating)
  activate RatingService

  RatingService -> RatingDB : Update shrine metrics (ratings, successRate, score)
  activate RatingDB
  RatingDB --> RatingService : ACK
  deactivate RatingDB

  RatingService --> TechniqueService : Event processed / new score
  deactivate RatingService

  TechniqueService ->> DiscoveryService : UpdateTechniqueIndex(shrineId, techniqueSummary)
  activate DiscoveryService
  DiscoveryService --> TechniqueService : ACK
  deactivate DiscoveryService

  TechniqueService --> APIGateway : 201 Created (techniqueId)
  deactivate TechniqueService

  APIGateway --> Frontend : 201 Created (techniqueId)
  Frontend --> User : Show success + shareable link

else Authentication failed
  APIGateway --> Frontend : 401 Unauthorized
  Frontend --> User : Prompt to login
end

== Post-submit (background / eventual consistency) ==
note over RatingService,DiscoveryService
  - RatingService recalculates shrine "ความขลัง" and stores aggregate metrics
  - RatingService recalculates shrine 'mystique' and stores aggregate metrics
  - DiscoveryService updates recommendation index used by shrine discovery and recommendation flows
end note

== Read / Browse compiled techniques ==
User -> Frontend : View shrine techniques
Frontend -> APIGateway : GET /shrines/{id}/techniques
APIGateway -> TechniqueService : ListTechniques(shrineId)
TechniqueService -> TechniqueDB : Query techniques by shrineId
TechniqueDB --> TechniqueService : techniques[]
TechniqueService --> APIGateway : techniques[]
APIGateway --> Frontend : techniques[]
Frontend --> User : Render compiled techniques + ratings

@enduml
